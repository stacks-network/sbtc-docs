<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bitcoin Transactions - sBTC Docs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././mdbook-admonish.css">

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction to sBTC</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guides</li><li class="chapter-item expanded "><a href="../how-to-deposit-and-withdraw.html"><strong aria-hidden="true">2.</strong> How to Deposit and Withdraw</a></li><li class="chapter-item expanded "><a href="../how-to-stacker.html"><strong aria-hidden="true">3.</strong> How to Participate as a Stacker</a></li><li class="chapter-item expanded affix "><li class="part-title">Developer Guides</li><li class="chapter-item expanded "><a href="../quickstart.html"><strong aria-hidden="true">4.</strong> Quickstart</a></li><li class="chapter-item expanded "><a href="../local-setup.html"><strong aria-hidden="true">5.</strong> Local Environment Setup</a></li><li class="chapter-item expanded "><a href="../tutorial.html"><strong aria-hidden="true">6.</strong> End to End Tutorial</a></li><li class="chapter-item expanded "><a href="../deposit.html"><strong aria-hidden="true">7.</strong> Initiating a Deposit</a></li><li class="chapter-item expanded "><a href="../withdrawal.html"><strong aria-hidden="true">8.</strong> Initiating a Withdrawal</a></li><li class="chapter-item expanded "><a href="../sbtc-sdk.html"><strong aria-hidden="true">9.</strong> The sBTC SDK</a></li><li class="chapter-item expanded affix "><li class="part-title">Signer Guides</li><li class="chapter-item expanded "><a href="../how-to-signer.html"><strong aria-hidden="true">10.</strong> How to Operate a Signer</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../developer-release-signer.html"><strong aria-hidden="true">10.1.</strong> Developer Release</a></li><li class="chapter-item expanded "><a href="../nakamoto-signer-developer-guide.html"><strong aria-hidden="true">10.2.</strong> Nakamoto Release</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">sBTC Design</li><li class="chapter-item expanded "><a href="../architecture.html"><strong aria-hidden="true">11.</strong> Architecture Overview</a></li><li class="chapter-item expanded "><a href="../sbtc-operations.html"><strong aria-hidden="true">12.</strong> sBTC Requests and Responses</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sbtc-operations/bitcoin-transactions.html" class="active"><strong aria-hidden="true">12.1.</strong> Bitcoin Transactions</a></li><li class="chapter-item expanded "><a href="../sbtc-operations/commit-reveal-system.html"><strong aria-hidden="true">12.2.</strong> The Commit-Reveal System</a></li><li class="chapter-item expanded "><a href="../clarity-contracts.html"><strong aria-hidden="true">12.3.</strong> Clarity Contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../stacker-responsibilities.html"><strong aria-hidden="true">13.</strong> Stacker responsibilities</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../stacker-responsibilities/frost.html"><strong aria-hidden="true">13.1.</strong> Signature Aggregation with FROST</a></li><li class="chapter-item expanded "><a href="../stacker-responsibilities/wsts-adaptation.html"><strong aria-hidden="true">13.2.</strong> WSTS Adaptation</a></li><li class="chapter-item expanded "><a href="../stacker-responsibilities/signing-protocol.html"><strong aria-hidden="true">13.3.</strong> Signing Protocol</a></li><li class="chapter-item expanded "><a href="../stacker-db.html"><strong aria-hidden="true">13.4.</strong> StackerDB</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">sBTC Releases</li><li class="chapter-item expanded "><a href="../sbtc-releases.html"><strong aria-hidden="true">14.</strong> sBTC Releases</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sbtc-releases/sbtc-dev.html"><strong aria-hidden="true">14.1.</strong> sBTC 0.1</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sbtc-releases/sbtc-dev/faq.html"><strong aria-hidden="true">14.1.1.</strong> FAQ</a></li><li class="chapter-item expanded "><a href="../sbtc-releases/sbtc-dev/limitations.html"><strong aria-hidden="true">14.1.2.</strong> Known Limitations</a></li></ol></li><li class="chapter-item expanded "><a href="../sbtc-releases/sbtc-nakamoto.html"><strong aria-hidden="true">14.2.</strong> sBTC 1.0</a></li><li class="chapter-item expanded "><a href="../sbtc-releases/sbtc-nakamoto-v2.html"><strong aria-hidden="true">14.3.</strong> sBTC 1.1</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">sBTC Docs</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="bitcoin-transactions"><a class="header" href="#bitcoin-transactions">Bitcoin Transactions</a></h1>
<p>This page outlines all transactions which happen on the Bitcoin blockchain within the sBTC protocol, and how they are represented on the bitcoin chain.</p>
<h1 id="data-and-opcodes"><a class="header" href="#data-and-opcodes">Data and opcodes</a></h1>
<p>Common to all sBTC transactions on Bitcoin is that they need to embed data on the Blockchain. To enable this, we require all sBTC transactions to have their first output be a script of the form</p>
<pre><code>OP_RETURN &lt; magic bytes | opcode | data &gt;
</code></pre>
<p>where <code>magic bytes</code> are special bytes required by the Stacks blockchain, the <code>opcode</code> identifies the type of the sBTC transaction, and the <code>data</code> field is specific to the transaction type. We use <code>|</code> as the concatenation operator to denote that all information is pushed as a single byte slice to the bitcoin script.</p>
<p>The magic bytes are</p>
<ul>
<li><code>X2</code> for Stacks mainnet</li>
<li><code>T2</code> for Stacks testnet</li>
</ul>
<p>The opcodes for sBTC are</p>
<ul>
<li><code>&lt;</code>: Deposit request</li>
<li><code>&gt;</code>: Withdrawal request</li>
<li><code>!</code>: Withdrawal fulfillment</li>
<li><code>H</code>: sBTC wallet handoff</li>
</ul>
<p>The following sections will go throuch each of these transactions and outline what data and outputs they require.</p>
<h2 id="deposit-request"><a class="header" href="#deposit-request">Deposit request</a></h2>
<p>The deposit request contains the following data (incl. opcode and magic byte) in its first output</p>
<pre><code>0       2  3                   66
|-------|--|-------------------|
| magic |op| Recipient address |
</code></pre>
<ul>
<li>Magic: <code>X2</code> or <code>T2</code></li>
<li>Opcode: <code>&lt;</code></li>
<li>Recipient address: Either a standard or a contract principal encoded as a Clarity value as defined in <a href="https://github.com/stacksgov/sips/blob/main/sips/sip-005/sip-005-blocks-and-transactions.md#clarity-value-representation">SIP-005</a>.</li>
</ul>
<p>The deposit transaction also has a second output which sends the requested amount to the sBTC wallet address.</p>
<h2 id="withdrawal-request"><a class="header" href="#withdrawal-request">Withdrawal request</a></h2>
<p>The withdrawal request contains the following data (incl. opcode and magic byte) in its first output</p>
<pre><code>0      2  3          11                76
|------|--|----------|-----------------|
 magic  op   amount       signature
</code></pre>
<ul>
<li>Magic: <code>X2</code> or <code>T2</code></li>
<li>Opcode: <code>&gt;</code></li>
<li>Amount: The amount to withdraw, as an 8-byte big-endian unsigned integer.</li>
<li>Signature: A 65 byte recoverable ECDSA signature authenticating the request.</li>
</ul>
<p>The withdrawal request is required to have two additional outputs beyond the data output. The second output is a dust amount to the recipient address. The third output is a fee subsidy to the sBTC wallet to fund the fulfillment of the withdrawal.</p>
<h3 id="signature"><a class="header" href="#signature">Signature</a></h3>
<p>The recoverable ECDSA signature in the withdrawal request ensures the authenticity and integrity of the transaction. Given that we use the secp256k1 elliptic curve (same as Bitcoin), this signature is composed of 65 bytes.</p>
<h4 id="message-format"><a class="header" href="#message-format">Message Format:</a></h4>
<p>Before diving into the signature's byte-level structure, let's clarify the format of the message being signed.</p>
<p>The signature attests to a withdrawal request from a specific stacks principal. The signed message encapsulates:</p>
<ol>
<li><strong>Amount (8 bytes)</strong>: The total amount to withdraw, encoded as an 8-byte big-endian unsigned integer.</li>
<li><strong>Recipient Address (<code>n</code> bytes)</strong>: This represents the intended beneficiary of the withdrawal. It's encoded as a Bitcoin script. The length of this script, denoted by <code>n</code>, can vary depending on the address format and type.</li>
</ol>
<p>These components are concatenated in the given order, resulting in a byte array with a total length of <code>n+8</code>:</p>
<pre><code>0      8                     n+8
|------|----------------------|
 amount        recipient
</code></pre>
<p>The actual message that gets signed is not this byte array directly but its SHA-256 hash, producing a consistent 32-byte digest.</p>
<h4 id="signature-structure"><a class="header" href="#signature-structure">Signature Structure:</a></h4>
<p>Now, with the hashed message ready, the structure of the recoverable ECDSA signature is as follows:</p>
<pre><code>0   1      33      65
|---|------|-------|
  v    r       s
</code></pre>
<ul>
<li>
<p><strong>v (1 byte)</strong>: The recovery ID, a value between 0 and 3. It's a critical component that facilitates the public key's recovery during verification, eliminating the need for its explicit provision.</p>
</li>
<li>
<p><strong>r (32 bytes)</strong>: A value linked to the x-coordinate of a point on the elliptic curve. It's a pivotal element in ECDSA's verification mechanism, effectively serving as proof of the signer's private key ownership.</p>
</li>
<li>
<p><strong>s (32 bytes)</strong>: This, combined with <code>r</code>, constitutes the essence of the ECDSA signature. Together, they confirm the validity and authenticity of the message.</p>
</li>
</ul>
<p>For the withdrawal request to be deemed valid, the signature must match the expected data.</p>
<h2 id="withdrawal-fulfillment"><a class="header" href="#withdrawal-fulfillment">Withdrawal fulfillment</a></h2>
<p>The withdrawal request contains the following data (incl. opcode and magic byte) in its first output</p>
<pre><code>0      2  3                     35
|------|--|---------------------|
 magic  op       Chain tip
</code></pre>
<ul>
<li>Magic: <code>X2</code> or <code>T2</code></li>
<li>Opcode: <code>!</code></li>
<li>Chain tip: The stacks chain tip used to vaildate the withdrawal.</li>
</ul>
<p>The withdrawal fulfillment has a second output which sends the requested amount to the recipient address.
Finally, the withdrawal fulfillment links back to the withdrawal request transaction by consuming the fee subsidy output of the withdrawal request as its first input.</p>
<h2 id="sbtc-wallet-handoff"><a class="header" href="#sbtc-wallet-handoff">sBTC wallet handoff</a></h2>
<p>The sBTC wallet handoff contains the following data (incl. opcode and magic byte) in its first output</p>
<pre><code>0      2  3                     11
|------|--|---------------------|
 magic  op     Reward cycle
</code></pre>
<ul>
<li>Magic: <code>X2</code> or <code>T2</code></li>
<li>Opcode: <code>H</code></li>
<li>Reward cycle: The reward cycle number of the Stacker set handing over the sBTC wallet.</li>
</ul>
<p>The second output sends an amount greater than or equal to the total amount of sBTC in circulation to the sBTC wallet of the next reward cycle.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../sbtc-operations.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../sbtc-operations/commit-reveal-system.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../sbtc-operations.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../sbtc-operations/commit-reveal-system.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
